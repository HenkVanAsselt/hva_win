<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">

<!-- This HTML file generated by cxref. -->
<!-- cxref program (c) Andrew M. Bishop 1995,96,97,98,99. -->

<!--
Cxref: cxref -DHVA_WIN -Id:/djgpp/include -Odoc/cxref -xref-all -Nhva_win -index-all -html32 -html32-src help.c
CPP  : gcc -E -C -dD -dI -DHVA_WIN -Id:/djgpp/include
-->

<HTML>

<HEAD>
<TITLE>Source File help.c</TITLE>
</HEAD>

<BODY>

<pre>
<a name="line1">1    |</a> /**************************************************************************
<a name="line2">2    |</a> $Header: Fri 10-27-2000 9:30:09 pm HvA V2.01 $
<a name="line3">3    |</a> 
<a name="line4">4    |</a> DESC: Help driver for HVA_WIN
<a name="line5">5    |</a>       Use GENINDEX to create the index file
<a name="line6">6    |</a> HIST: 19911127 V00.2 - Generalized page break and end of topic character sequences
<a name="line7">7    |</a>       19920211 V00.3 - uses LIFO stack to switch between display's   
<a name="line8">8    |</a> 	  20001027 V2.01 - Adapted for HVA_WIN
<a name="line9">9    |</a> ***************************************************************************/
<a name="line10">10   |</a> 
<a name="line11">11   |</a> /*===========================================================================
<a name="line12">12   |</a> 
<a name="line13">13   |</a>   HelpPC text files are simple ASCII files that contain control codes
<a name="line14">14   |</a>   in column one.   Each file must contain a menu title in the first
<a name="line15">15   |</a>   line.  The remainder of the file consists of keyed lines and help
<a name="line16">16   |</a>   text.  Each line must end with a CR/LF pair (standard DOS format) and
<a name="line17">17   |</a>   shouldn't be longer than 79 characters.   Tabs position the text at
<a name="line18">18   |</a>   8 character tab positions.  The following is a list of keys and
<a name="line19">19   |</a>   special characters (keys are found in column 1, special characters
<a name="line20">20   |</a>   appear in columns 1-80):
<a name="line21">21   |</a> 
<a name="line22">22   |</a>    '@'  in column 1 indicates a file title which will appear in
<a name="line23">23   |</a>         the main topic menu.  This must be the very first line
<a name="line24">24   |</a>         in the file and has a maximum length of 40 characters
<a name="line25">25   |</a>         (excluding the '@').
<a name="line26">26   |</a>    ':'  in column 1 indicates a topic key.  Multiple keys separated
<a name="line27">27   |</a>         by colons ':' can be entered on the same line.  Single spaces
<a name="line28">28   |</a>         are allowed in a key, multiple spaces are compressed to single.
<a name="line29">29   |</a>    '%'  in column 1 indicates a highlighted title line.
<a name="line30">30   |</a>    '^'  in column 1 indicates a centered highlighted title.
<a name="line31">31   |</a>    ' '  (space) in column 1 indicates normal text.
<a name="line32">32   |</a>    '~'  Tilde is used to mark text as a topic link.  Use two
<a name="line33">33   |</a>         tilde characters to represent an actual tilde in the data.
<a name="line34">34   |</a>         A word or phrase enclosed between tilde's will become a
<a name="line35">35   |</a>         topic link for the current topic.
<a name="line36">36   |</a>    TAB  in column 1 starts text in column 9
<a name="line37">37   |</a>    any other character in column 1 is truncated
<a name="line38">38   |</a> 
<a name="line39">39   |</a>    Limits of the genindex() and help()
<a name="line40">40   |</a> 
<a name="line41">41   |</a>    Max items in topic menu:              512
<a name="line42">42   |</a>    Max topics in index:                 1800
<a name="line43">43   |</a>    Max size of topic text:             16384 bytes
<a name="line44">44   |</a>    Max lines of text per topic:          512
<a name="line45">45   |</a>    Max topic key length:                  20
<a name="line46">46   |</a>    Max file title length:                 40
<a name="line47">47   |</a>    Max topic links:                      120
<a name="line48">48   |</a>    No limit on text file size
<a name="line49">49   |</a> 
<a name="line50">50   |</a> =============================================================================*/
<a name="line51">51   |</a> 
<a name="line52">52   |</a> /*------------------------------------------------------------------------------
<a name="line53">53   |</a>                         HEADER FILES
<a name="line54">54   |</a> ------------------------------------------------------------------------------*/
<a name="line55">55   |</a> #include &lt;stdio.h&gt;
<a name="line56">56   |</a> #include &lt;stdlib.h&gt;
<a name="line57">57   |</a> #include &lt;math.h&gt;
<a name="line58">58   |</a> #include &lt;string.h&gt;
<a name="line59">59   |</a> #include &lt;conio.h&gt;        /* For color definitions */
<a name="line60">60   |</a> #include &quot;video/v_video.h&quot;
<a name="line61">61   |</a> #include &quot;keys.h&quot;
<a name="line62">62   |</a> #include &quot;window.h&quot;
<a name="line63">63   |</a> 
<a name="line64">64   |</a> /*------------------------------------------------------------------------------
<a name="line65">65   |</a>                         PROTOTYPES
<a name="line66">66   |</a> ------------------------------------------------------------------------------*/
<a name="line67">67   |</a> static void show_line(WINDOW *w, int linenr, char *s);
<a name="line68">68   |</a> static void show_topic(long offset);
<a name="line69">69   |</a> static int  filbuf(long offset, int flag);
<a name="line70">70   |</a> static int  find_topiclink(int linenr, int n);
<a name="line71">71   |</a> static int  push_subject(char *s);
<a name="line72">72   |</a> static char *pop_subject(void);
<a name="line73">73   |</a> static void display_stack(void);
<a name="line74">74   |</a> 
<a name="line75">75   |</a> extern SCREEN _cursvar;
<a name="line76">76   |</a> 
<a name="line77">77   |</a> /*------------------------------------------------------------------------------
<a name="line78">78   |</a>                         CONSTANTS
<a name="line79">79   |</a> ------------------------------------------------------------------------------*/
<a name="line80">80   |</a> 
<a name="line81">81   |</a> #define KEY_LEN        25    /* Maximum lenght of a key      */
<a name="line82">82   |</a> #define MAX_LINES     512    /* Max no lines in text buffer  */
<a name="line83">83   |</a> #define MAXKEY        512    /* Maximum number of topics     */
<a name="line84">84   |</a> #define HELP_LINE_LEN  90    /* Maximum lenght of a line     */
<a name="line85">85   |</a> 
<a name="line86">86   |</a> typedef struct    /* topic list structure         */
<a name="line87">87   |</a> {
<a name="line88">88   |</a>   char *key;      /* pointer to :info string      */
<a name="line89">89   |</a>   long loc;       /* file offset                  */
<a name="line90">90   |</a> }
<a name="line91">91   |</a> TOPIC;
<a name="line92">92   |</a> 
<a name="line93">93   |</a> typedef struct    /* TOPIC_LINK structure         */
<a name="line94">94   |</a> {
<a name="line95">95   |</a>   char *key;      /* pointer to topic string                              */
<a name="line96">96   |</a>   int  line;      /* Line of topic link.     Set to -1 for unused entries */
<a name="line97">97   |</a>   int  pos;       /* Position in line        Set to -1 for unused entries */
<a name="line98">98   |</a>   int  len;       /* Length of topic string  Set to -1 for unused entries */
<a name="line99">99   |</a> }
<a name="line100">100  |</a> TOPIC_LINK;
<a name="line101">101  |</a> 
<a name="line102">102  |</a> /*------------------------------------------------------------------------------
<a name="line103">103  |</a>                         LOCAL VARIABLES
<a name="line104">104  |</a> ------------------------------------------------------------------------------*/
<a name="line105">105  |</a> TOPIC       topic[MAXKEY];          /* topic list                   */
<a name="line106">106  |</a> TOPIC_LINK  topic_link[MAXKEY];     /* topic link list              */
<a name="line107">107  |</a> char        *topic_txt[MAXKEY];     /* Topic text buffer pointers   */
<a name="line108">108  |</a> 
<a name="line109">109  |</a> static FILE *fp;                    /* stream file pointer          */
<a name="line110">110  |</a> 
<a name="line111">111  |</a> static WINDOW   *wn;                /* window pointer                     */
<a name="line112">112  |</a> 
<a name="line113">113  |</a> static int  initflg = FALSE;        /* init complete flag                 */
<a name="line114">114  |</a> static int  startline = 0;          /* first line of textbuffer in window */
<a name="line115">115  |</a> static int  height = 0;             /* Hight of the window (no of lines)  */
<a name="line116">116  |</a> static int  endline   = 0;          /* Last line on the screen            */
<a name="line117">117  |</a> static int  link_selected = 0;      /* Selected topic link                */
<a name="line118">118  |</a> static int  no_topics;
<a name="line119">119  |</a> static char current_subject[KEY_LEN];
<a name="line120">120  |</a> static char *subject = NULL;
<a name="line121">121  |</a> static char *topic_key_buffer = NULL;
<a name="line122">122  |</a> static char *topic_txt_buffer = NULL;
<a name="line123">123  |</a> static char *link_key_buffer  = NULL;
<a name="line124">124  |</a> 
<a name="line125">125  |</a> #define MAX_TOS 25                   /* Dimension of stack        */
<a name="line126">126  |</a> static char stack[MAX_TOS][KEY_LEN]; /* stack of MAX_TOS keys     */
<a name="line127">127  |</a> static int tos = 0;                  /* top of stack              */
<a name="line128">128  |</a> 
<a name="line129">129  |</a> /*---------------------------------
<a name="line130">130  |</a>   Subjects to push on the stack:
<a name="line131">131  |</a> 
<a name="line132">132  |</a>   startline,
<a name="line133">133  |</a>   endline,
<a name="line134">134  |</a>   link_selected,
<a name="line135">135  |</a>   no_topics
<a name="line136">136  |</a> 
<a name="line137">137  |</a> ---------------------------------*/
<a name="line138">138  |</a> 
<a name="line139">139  |</a> 
<a name="line140">140  |</a> 
<a name="line141">141  |</a> /*------------------------------------------------------------------------------
<a name="line142">142  |</a>                         GLOBAL VARIABLES
<a name="line143">143  |</a> ------------------------------------------------------------------------------*/
<a name="line144">144  |</a> char *default_subject = NULL;
<a name="line145">145  |</a> 
<a name="line146">146  |</a> /*==============================================================================
<a name="line147">147  |</a>                         START OF FUNCTIONS
<a name="line148">148  |</a> ==============================================================================*/
<a name="line149">149  |</a> 
<a name="line150">150  |</a> /*#+func-----------------------------------------------------------------------
<a name="line151">151  |</a>     FUNCTION: push_subject()
<a name="line152">152  |</a>      PURPOSE: push an item on the stack
<a name="line153">153  |</a>  DESCRIPTION: LIFO buffer
<a name="line154">154  |</a>      RETURNS: New top of stack
<a name="line155">155  |</a>      HISTORY: 920211 V0.1
<a name="line156">156  |</a> --#-func----------------------------------------------------------------------*/
<a name="line157">157  |</a> static int push_subject(char *s)
<a name="line158">158  |</a> {
<a name="line159">159  |</a>   /*---------------------------------------------
<a name="line160">160  |</a>     If stack is not full, push data on the stack
<a name="line161">161  |</a>   -----------------------------------------------*/
<a name="line162">162  |</a>   if (tos &lt; MAX_TOS)
<a name="line163">163  |</a>   {
<a name="line164">164  |</a>     strcpy(stack[tos],s);
<a name="line165">165  |</a>     tos++;
<a name="line166">166  |</a>   }
<a name="line167">167  |</a>   return(tos);
<a name="line168">168  |</a> }
<a name="line169">169  |</a> 
<a name="line170">170  |</a> /*#+func-----------------------------------------------------------------------
<a name="line171">171  |</a>     FUNCTION: pop_subject()
<a name="line172">172  |</a>      PURPOSE: pop an item from the stack
<a name="line173">173  |</a>  DESCRIPTION: LIFO buffer
<a name="line174">174  |</a>      RETURNS: item number
<a name="line175">175  |</a>      HISTORY: 920211 V0.1
<a name="line176">176  |</a> --#-func----------------------------------------------------------------------*/
<a name="line177">177  |</a> static char *pop_subject()
<a name="line178">178  |</a> {
<a name="line179">179  |</a>   tos--;
<a name="line180">180  |</a>   if (tos &lt; 0)
<a name="line181">181  |</a>   {
<a name="line182">182  |</a>     /*----------------
<a name="line183">183  |</a>       Stack is empty
<a name="line184">184  |</a>     -----------------*/
<a name="line185">185  |</a>     tos++;
<a name="line186">186  |</a>     return(NULL);
<a name="line187">187  |</a>   }
<a name="line188">188  |</a>   else
<a name="line189">189  |</a>   {
<a name="line190">190  |</a>     /*---------------------------------
<a name="line191">191  |</a>       return contents of top of stack
<a name="line192">192  |</a>     ----------------------------------*/
<a name="line193">193  |</a>     return(stack[tos]);
<a name="line194">194  |</a>   }
<a name="line195">195  |</a> }
<a name="line196">196  |</a> 
<a name="line197">197  |</a> /*#+func-------------------------------------------------------------------
<a name="line198">198  |</a>    FUNCTION: init_help(char *help_file_name)
<a name="line199">199  |</a>     PURPOSE: Will initialize help functions and parameters
<a name="line200">200  |</a>  DESRIPTION: Initializing will be done by help() function and
<a name="line201">201  |</a>              includes allocation of memory and building the
<a name="line202">202  |</a>              topic index table.
<a name="line203">203  |</a>     RETURNS: TRUE if successfull, FALSE if not
<a name="line204">204  |</a>     VERSION: 901115 V0.2
<a name="line205">205  |</a> --#-func-------------------------------------------------------------------*/
<a name="line206">206  |</a> int init_help(char *help_file_name)
<a name="line207">207  |</a> {
<a name="line208">208  |</a>   int i;
<a name="line209">209  |</a>   char tmpname[30];                   /* temporary filename */
<a name="line210">210  |</a>   char *ptr;
<a name="line211">211  |</a>   char line[HELP_LINE_LEN];           /* line buffer                     */
<a name="line212">212  |</a> 
<a name="line213">213  |</a>   if (initflg)
<a name="line214">214  |</a>   {
<a name="line215">215  |</a>     wn_error(&quot;Help system for %s already initialized&quot;,*help_file_name);
<a name="line216">216  |</a>     return(initflg);
<a name="line217">217  |</a>   }
<a name="line218">218  |</a> 
<a name="line219">219  |</a>   /*-----------------------------------------------
<a name="line220">220  |</a>   | allocate memory for strings in topic key index
<a name="line221">221  |</a>   | and allocate pointers to it.
<a name="line222">222  |</a>   ------------------------------------------------*/
<a name="line223">223  |</a>   topic_key_buffer = calloc(MAXKEY,KEY_LEN);
<a name="line224">224  |</a>   if (!topic_key_buffer)
<a name="line225">225  |</a>   {
<a name="line226">226  |</a>     wn_error(&quot;ERROR in allocating TOPIC_KEY_BUFFER&quot;);
<a name="line227">227  |</a>     return(initflg);
<a name="line228">228  |</a>   }
<a name="line229">229  |</a>   for(i=0; i&lt;MAXKEY; i++)
<a name="line230">230  |</a>     topic[i].key = topic_key_buffer + i*KEY_LEN;
<a name="line231">231  |</a> 
<a name="line232">232  |</a>   /*--------------------------------------------------
<a name="line233">233  |</a>     Call exit_help when exiting from the main program
<a name="line234">234  |</a>   ----------------------------------------------------*/
<a name="line235">235  |</a>   atexit(exit_help);
<a name="line236">236  |</a> 
<a name="line237">237  |</a>   /*-----------------------------------------------------
<a name="line238">238  |</a>   | Build the topic index table will be build by using
<a name="line239">239  |</a>   | file 'subject.ndx'. After this the helpfile
<a name="line240">240  |</a>   | 'subject.hlp' will be opened and left open to use
<a name="line241">241  |</a>   -------------------------------------------------------*/
<a name="line242">242  |</a>   strcpy(tmpname,help_file_name);   /* form filename from root */
<a name="line243">243  |</a>   strcat(tmpname,&quot;.ndx&quot;);
<a name="line244">244  |</a>   fp = fopen(tmpname,&quot;r&quot;);
<a name="line245">245  |</a>   if (!fp)                          /* index file cant be found ! */
<a name="line246">246  |</a>   {
<a name="line247">247  |</a>     wn_error(&quot;Can't find indexfile %s for help functions&quot;,tmpname);
<a name="line248">248  |</a>     return(initflg);
<a name="line249">249  |</a>   }
<a name="line250">250  |</a>   i = 0;                                /* read and process key file */
<a name="line251">251  |</a>   while(fgets(line,HELP_LINE_LEN,fp))   /* build the topic index table */
<a name="line252">252  |</a>   {
<a name="line253">253  |</a>     ptr = strchr(line,'\n');        /* Find '\n'        */
<a name="line254">254  |</a>     if (ptr) *ptr = '\0';           /* And make it '\0' */
<a name="line255">255  |</a>     strcpy(topic[i].key, line);
<a name="line256">256  |</a> 
<a name="line257">257  |</a>     #ifdef DONT_SKIP_THIS
<a name="line258">258  |</a> 
<a name="line259">259  |</a>     if(line[0] != ':')              /* ignore all but subjects */
<a name="line260">260  |</a>       continue;
<a name="line261">261  |</a> 
<a name="line262">262  |</a>     #endif
<a name="line263">263  |</a> 
<a name="line264">264  |</a>     fgets(line,HELP_LINE_LEN,fp);
<a name="line265">265  |</a>     topic[i].loc = atol(line);
<a name="line266">266  |</a>     i++;
<a name="line267">267  |</a>   }
<a name="line268">268  |</a>   fclose(fp);                       /* close index file */
<a name="line269">269  |</a>   strcpy(tmpname, help_file_name);  /* form help file name from root */
<a name="line270">270  |</a>   strcat(tmpname, &quot;.hlp&quot;);          /* open and leave open ! */
<a name="line271">271  |</a>   fp = fopen(tmpname, &quot;r&quot;);
<a name="line272">272  |</a>   if (!fp)
<a name="line273">273  |</a>     return(initflg);
<a name="line274">274  |</a> 
<a name="line275">275  |</a>   initflg = TRUE;
<a name="line276">276  |</a>   return(initflg);
<a name="line277">277  |</a> 
<a name="line278">278  |</a> }
<a name="line279">279  |</a> 
<a name="line280">280  |</a> /*#+func-------------------------------------------------------------------
<a name="line281">281  |</a>    FUNCTION: help()
<a name="line282">282  |</a>     PURPOSE: Show help text about 'subject'
<a name="line283">283  |</a>  DESRIPTION: When the first character of 'subject' is a ':' then
<a name="line284">284  |</a>              the help text will be displayed.
<a name="line285">285  |</a>     RETURNS: TRUE if successfull, FALSE if not
<a name="line286">286  |</a>     VERSION: 901114 V0.1
<a name="line287">287  |</a> --#-func-------------------------------------------------------------------*/
<a name="line288">288  |</a> int help(char *in_subject)
<a name="line289">289  |</a> {
<a name="line290">290  |</a>   int i;                                  /* scratch integers */
<a name="line291">291  |</a>   int  topic_found = FALSE;
<a name="line292">292  |</a> 
<a name="line293">293  |</a>   if (!initflg)
<a name="line294">294  |</a>   {
<a name="line295">295  |</a>     wn_error(&quot;HELP system not initialized&quot;);
<a name="line296">296  |</a>     return(FALSE);
<a name="line297">297  |</a>   }
<a name="line298">298  |</a> 
<a name="line299">299  |</a>   wn_log_indent(2);
<a name="line300">300  |</a>   wn_log(&quot;HELP() START ****\n&quot;);
<a name="line301">301  |</a> 
<a name="line302">302  |</a>   /*------------------------------------------
<a name="line303">303  |</a>     Allocate memory for topic text buffer
<a name="line304">304  |</a>     and assign pointer to it.
<a name="line305">305  |</a>   ------------------------------------------*/
<a name="line306">306  |</a>   topic_txt_buffer = calloc(MAX_LINES,HELP_LINE_LEN);
<a name="line307">307  |</a>   if (!topic_txt_buffer)
<a name="line308">308  |</a>   {
<a name="line309">309  |</a>     wn_error(&quot;ERROR in allocating TOPIC_TXT_BUFFER&quot;);
<a name="line310">310  |</a>     return(FALSE);
<a name="line311">311  |</a>   }
<a name="line312">312  |</a>   for(i=0; i&lt;MAX_LINES; i++) /* Assign pointers to each text line*/
<a name="line313">313  |</a>     topic_txt[i] =  topic_txt_buffer + i*HELP_LINE_LEN;
<a name="line314">314  |</a> 
<a name="line315">315  |</a>   /*--------------------------------------------
<a name="line316">316  |</a>   | allocate memory for topic link key buffer
<a name="line317">317  |</a>   | and assign pointer to it.
<a name="line318">318  |</a>   --------------------------------------------*/
<a name="line319">319  |</a>   link_key_buffer = calloc(MAXKEY,KEY_LEN);
<a name="line320">320  |</a>   if (!link_key_buffer)
<a name="line321">321  |</a>   {
<a name="line322">322  |</a>     wn_error(&quot;ERROR in allocating memory for LINK_KEY_BUFFER&quot;);
<a name="line323">323  |</a>     return(FALSE);
<a name="line324">324  |</a>   }
<a name="line325">325  |</a>   for(i=0; i&lt;MAXKEY; i++)
<a name="line326">326  |</a>     topic_link[i].key =  link_key_buffer + i*KEY_LEN;
<a name="line327">327  |</a> 
<a name="line328">328  |</a>   /*--------------------------------
<a name="line329">329  |</a>     Remove leading ':' from subject
<a name="line330">330  |</a>   ----------------------------------*/
<a name="line331">331  |</a>   if (in_subject &amp;&amp; in_subject[0] == ':')
<a name="line332">332  |</a>   {
<a name="line333">333  |</a>     in_subject[0] = ' ';
<a name="line334">334  |</a>     trimstr(in_subject);
<a name="line335">335  |</a>   }
<a name="line336">336  |</a> 
<a name="line337">337  |</a>   /*--------------------------------------------------------
<a name="line338">338  |</a>     If no in_subject given, set subject to default subject
<a name="line339">339  |</a>   ---------------------------------------------------------*/
<a name="line340">340  |</a>   if (in_subject == NULL || in_subject[0] == '\0')
<a name="line341">341  |</a>   {
<a name="line342">342  |</a>     if (default_subject)
<a name="line343">343  |</a>       in_subject = default_subject;
<a name="line344">344  |</a>     else {
<a name="line345">345  |</a>       wn_error(&quot;No default subject given&quot;);
<a name="line346">346  |</a>       return(FALSE);
<a name="line347">347  |</a>     }
<a name="line348">348  |</a>   }
<a name="line349">349  |</a> 
<a name="line350">350  |</a>   strcpy(current_subject,in_subject);
<a name="line351">351  |</a> 
<a name="line352">352  |</a>   subject = in_subject;
<a name="line353">353  |</a> 
<a name="line354">354  |</a>   wn = wn_open(_SINGLE_LINE,0,0,_cursvar.cols,_cursvar.lines,
<a name="line355">355  |</a>                _help_text,_help_border);
<a name="line356">356  |</a>   if (!wn)
<a name="line357">357  |</a>     return(FALSE);
<a name="line358">358  |</a> 
<a name="line359">359  |</a>   height = (wn-&gt;y2 - wn-&gt;y1) + 1;
<a name="line360">360  |</a> 
<a name="line361">361  |</a>   while (TRUE)
<a name="line362">362  |</a>   {
<a name="line363">363  |</a>     /*----------------------------
<a name="line364">364  |</a>       Check if a subject is given
<a name="line365">365  |</a>     ------------------------------*/
<a name="line366">366  |</a>     if (subject == NULL)
<a name="line367">367  |</a>       break;
<a name="line368">368  |</a> 
<a name="line369">369  |</a>     /*-----------------------------
<a name="line370">370  |</a>       Search for key in topic list
<a name="line371">371  |</a>     -------------------------------*/
<a name="line372">372  |</a>     i=0;
<a name="line373">373  |</a>     topic_found = FALSE;
<a name="line374">374  |</a>     while(i &lt; MAXKEY)
<a name="line375">375  |</a>     {
<a name="line376">376  |</a>       trimstr(subject);
<a name="line377">377  |</a>       trimstr(topic[i].key);
<a name="line378">378  |</a>       if(!strcmp(subject,topic[i].key))
<a name="line379">379  |</a>       {
<a name="line380">380  |</a>         topic_found = TRUE;
<a name="line381">381  |</a>         break;
<a name="line382">382  |</a>       }
<a name="line383">383  |</a>       else i++;
<a name="line384">384  |</a>     }
<a name="line385">385  |</a> 
<a name="line386">386  |</a>     /*---------------------------------------
<a name="line387">387  |</a>       If key was found, display text of topic
<a name="line388">388  |</a>     -----------------------------------------*/
<a name="line389">389  |</a>     if (topic_found)
<a name="line390">390  |</a>     {
<a name="line391">391  |</a>       show_topic(topic[i].loc);
<a name="line392">392  |</a>     }
<a name="line393">393  |</a>     else
<a name="line394">394  |</a>     {
<a name="line395">395  |</a>       /*---------------------------------------
<a name="line396">396  |</a>         Show that topic text is not available
<a name="line397">397  |</a>       ----------------------------------------*/
<a name="line398">398  |</a>       wn_error(&quot;Sorry... No help available on subject %s&quot;,subject);
<a name="line399">399  |</a> 
<a name="line400">400  |</a>       /*-------------------------------------------------
<a name="line401">401  |</a>         Retrieve last subject from stack. If no subject
<a name="line402">402  |</a>         is available, then stop this loop
<a name="line403">403  |</a>       -------------------------------------------------*/
<a name="line404">404  |</a>       subject = pop_subject();
<a name="line405">405  |</a>       if (subject)
<a name="line406">406  |</a>       {
<a name="line407">407  |</a>         strcpy(current_subject,subject);
<a name="line408">408  |</a>         subject = current_subject;
<a name="line409">409  |</a>       }
<a name="line410">410  |</a>       else      /* No subjects available any more */
<a name="line411">411  |</a>         break;
<a name="line412">412  |</a>     }
<a name="line413">413  |</a> 
<a name="line414">414  |</a>   }
<a name="line415">415  |</a> 
<a name="line416">416  |</a>   /*--------------------
<a name="line417">417  |</a>     Close help window
<a name="line418">418  |</a>   ---------------------*/
<a name="line419">419  |</a>   wn_close(wn);
<a name="line420">420  |</a> 
<a name="line421">421  |</a>   /*-------------------------------------
<a name="line422">422  |</a>     Free allocated memory
<a name="line423">423  |</a>   ---------------------------------------*/
<a name="line424">424  |</a>   free(topic_txt_buffer);
<a name="line425">425  |</a>   free(link_key_buffer);
<a name="line426">426  |</a> 
<a name="line427">427  |</a>   wn_log_indent(-2);
<a name="line428">428  |</a>   wn_log(&quot;HELP() END *****\n&quot;);
<a name="line429">429  |</a> 
<a name="line430">430  |</a>   return(FALSE);
<a name="line431">431  |</a> }
<a name="line432">432  |</a> 
<a name="line433">433  |</a> /*#+func-----------------------------------------------------------------------
<a name="line434">434  |</a>     FUNCTION: find_topiclink()
<a name="line435">435  |</a>      PURPOSE: Find the link in the topic link list
<a name="line436">436  |</a>       SYNTAX: static int find_topiclink(int linenr, int n);
<a name="line437">437  |</a>  DESCRIPTION: int n : return the index of the n'th topic in this line.
<a name="line438">438  |</a>      RETURNS: the index of the n'th topic in the line.
<a name="line439">439  |</a>               If no link is found, -1 will be returned.
<a name="line440">440  |</a>      HISTORY: 920205 V0.1
<a name="line441">441  |</a>               29-Sep-1992 20:52:42 V0.2 -
<a name="line442">442  |</a> --#-func----------------------------------------------------------------------*/
<a name="line443">443  |</a> static int find_topiclink(int linenr, int n)
<a name="line444">444  |</a> {
<a name="line445">445  |</a>   int i;
<a name="line446">446  |</a>   int line;
<a name="line447">447  |</a> 
<a name="line448">448  |</a>   /*---------------------------------------
<a name="line449">449  |</a>     Find the 1st topic in this line
<a name="line450">450  |</a>   ---------------------------------------*/
<a name="line451">451  |</a>   i = -1;               /* Reset index */
<a name="line452">452  |</a>   while (TRUE) {
<a name="line453">453  |</a>     i++;
<a name="line454">454  |</a>     line = topic_link[i].line;
<a name="line455">455  |</a>     if (line &gt; linenr)
<a name="line456">456  |</a>       return(-1);      /* We are past the wanted line in the list    */
<a name="line457">457  |</a>     if (line &lt; 0)
<a name="line458">458  |</a>       return(-1);      /* We ran out of the actual number of topics  */
<a name="line459">459  |</a>     else if (i &gt;= MAXKEY)
<a name="line460">460  |</a>       return(-1);      /* We ran out of the maximum number of topics */
<a name="line461">461  |</a>     else if (line == linenr) {
<a name="line462">462  |</a>       if (n &lt;= 0)
<a name="line463">463  |</a>         return(i);     /* We found the n'th topic on the line        */
<a name="line464">464  |</a>       else
<a name="line465">465  |</a>         n--;
<a name="line466">466  |</a>     }
<a name="line467">467  |</a>   }
<a name="line468">468  |</a> }
<a name="line469">469  |</a> 
<a name="line470">470  |</a> /*#+func-----------------------------------------------------------------------
<a name="line471">471  |</a>     FUNCTION: check_screen()
<a name="line472">472  |</a>      PURPOSE: Check variables for drawing the help screen
<a name="line473">473  |</a>       SYNTAX: static int check_screen(int *sl, int *el, int no_lines);
<a name="line474">474  |</a>               int *sl      : pointer to startline
<a name="line475">475  |</a>               int *el      : pointner to endline
<a name="line476">476  |</a>               int no_lines : number of help lines for the current topic
<a name="line477">477  |</a>  DESCRIPTION:
<a name="line478">478  |</a>      RETURNS: TRUE if screen has to be redrawn,
<a name="line479">479  |</a>               FALSE if not
<a name="line480">480  |</a>      HISTORY: 30-Sep-1992 22:19:39 V0.1
<a name="line481">481  |</a> --#-func----------------------------------------------------------------------*/
<a name="line482">482  |</a> static int check_screen(int *sl, int *el, int no_lines)
<a name="line483">483  |</a> {
<a name="line484">484  |</a>   int redraw = FALSE;
<a name="line485">485  |</a> 
<a name="line486">486  |</a>   /*-------------------------------------------------------------
<a name="line487">487  |</a>     Check on valid start line:
<a name="line488">488  |</a>     (1) The startline must be at least 0 and
<a name="line489">489  |</a>         at most MAX_LINES - window height
<a name="line490">490  |</a>     (2) If there are less textlines then the window height,
<a name="line491">491  |</a>         the startline number is 0.
<a name="line492">492  |</a>   ------------------------------------------------------------*/
<a name="line493">493  |</a>   if (*sl &lt; 0) {
<a name="line494">494  |</a>     redraw = TRUE;
<a name="line495">495  |</a>     *sl = 0;
<a name="line496">496  |</a>   }
<a name="line497">497  |</a>   if (*sl &gt; (MAX_LINES-height+1)) {
<a name="line498">498  |</a>     redraw = TRUE;
<a name="line499">499  |</a>     *sl = MAX_LINES-height+1;
<a name="line500">500  |</a>   }
<a name="line501">501  |</a>   if (no_lines &gt; height) {
<a name="line502">502  |</a>     redraw = TRUE;
<a name="line503">503  |</a>     *sl = min(*sl,no_lines-height+11);
<a name="line504">504  |</a>   }
<a name="line505">505  |</a>   if (no_lines &lt; height) {
<a name="line506">506  |</a>     redraw = TRUE;
<a name="line507">507  |</a>     *sl = 0;
<a name="line508">508  |</a>   }
<a name="line509">509  |</a> 
<a name="line510">510  |</a>   /*---------------------------------------------------------
<a name="line511">511  |</a>     Check on valid end line:
<a name="line512">512  |</a>     (1) The last line in the window is at
<a name="line513">513  |</a>         most the number of the startline + the height of
<a name="line514">514  |</a>         the window.
<a name="line515">515  |</a>     (2) If there are less textlines then the window height,
<a name="line516">516  |</a>         the last textline is 'no_lines
<a name="line517">517  |</a>   ----------------------------------------------------------*/
<a name="line518">518  |</a>   if (no_lines &gt; height) {
<a name="line519">519  |</a>     *el = *sl + height - 1;
<a name="line520">520  |</a>     redraw = TRUE;
<a name="line521">521  |</a>   }
<a name="line522">522  |</a>   if (no_lines &lt; height) {
<a name="line523">523  |</a>     *el = no_lines - 1;
<a name="line524">524  |</a>     redraw = TRUE;
<a name="line525">525  |</a>   }
<a name="line526">526  |</a> 
<a name="line527">527  |</a>   return(redraw);
<a name="line528">528  |</a> 
<a name="line529">529  |</a> }
<a name="line530">530  |</a> 
<a name="line531">531  |</a> 
<a name="line532">532  |</a> /*#+func-----------------------------------------------------------------------
<a name="line533">533  |</a>     FUNCTION: prev_link()
<a name="line534">534  |</a>      PURPOSE: Find previous link
<a name="line535">535  |</a>       SYNTAX: int prev_link(int curlink, int maxlink);
<a name="line536">536  |</a>               int curlink : current link
<a name="line537">537  |</a>               int maxlink : maximum number of links
<a name="line538">538  |</a>      RETURNS: previous link found
<a name="line539">539  |</a>  DESCRIPTION:
<a name="line540">540  |</a>      HISTORY: 06-Oct-1992 21:26:45 V0.1
<a name="line541">541  |</a> --#-func----------------------------------------------------------------------*/
<a name="line542">542  |</a> int prev_link(int curlink, int maxlink)
<a name="line543">543  |</a> {
<a name="line544">544  |</a>   maxlink=0;
<a name="line545">545  |</a> 
<a name="line546">546  |</a>   if (curlink &gt; 0)
<a name="line547">547  |</a>     return(curlink-1);
<a name="line548">548  |</a>   else
<a name="line549">549  |</a>     return(curlink);
<a name="line550">550  |</a> }
<a name="line551">551  |</a> 
<a name="line552">552  |</a> /*#+func-----------------------------------------------------------------------
<a name="line553">553  |</a>     FUNCTION: next_link()
<a name="line554">554  |</a>      PURPOSE: Find next link
<a name="line555">555  |</a>       SYNTAX: int next_link(int curlink, int maxlink);
<a name="line556">556  |</a>               int curlink : current link
<a name="line557">557  |</a>               int maxlink : maximum number of links
<a name="line558">558  |</a>      RETURNS: next link found
<a name="line559">559  |</a>      HISTORY: 06-Oct-1992 21:26:45 V
<a name="line560">560  |</a> --#-func----------------------------------------------------------------------*/
<a name="line561">561  |</a> int next_link(int curlink, int maxlink)
<a name="line562">562  |</a> {
<a name="line563">563  |</a>   if (curlink &lt; (maxlink-1))
<a name="line564">564  |</a>     return(curlink+1);
<a name="line565">565  |</a>   else
<a name="line566">566  |</a>     return(curlink);
<a name="line567">567  |</a> }
<a name="line568">568  |</a> 
<a name="line569">569  |</a> /*#+func-----------------------------------------------------------------------
<a name="line570">570  |</a>     FUNCTION: redraw_helpscreen()
<a name="line571">571  |</a>      PURPOSE: redraw complete help screen
<a name="line572">572  |</a>       SYNTAX: void redraw_helpscreen(WINDOW *w, int startline, int no_lines);
<a name="line573">573  |</a>               WINDOW *w    : Pointer to opened help window
<a name="line574">574  |</a>               int startline: first textbuffer line in window
<a name="line575">575  |</a>               int no_lines:  number of text lines
<a name="line576">576  |</a>  DESCRIPTION: -
<a name="line577">577  |</a>      RETURNS: nothing
<a name="line578">578  |</a>      HISTORY: 07-Oct-1992 19:24:53 V
<a name="line579">579  |</a> --#-func----------------------------------------------------------------------*/
<a name="line580">580  |</a> void redraw_helpscreen(WINDOW *w, int startline, int no_lines)
<a name="line581">581  |</a> {
<a name="line582">582  |</a>   int j;
<a name="line583">583  |</a> 
<a name="line584">584  |</a>   for(j=0; j&lt;no_lines &amp;&amp; j &lt; height; j++) {
<a name="line585">585  |</a>     show_line(w,startline+j,topic_txt[startline+j]);
<a name="line586">586  |</a>   }
<a name="line587">587  |</a> }
<a name="line588">588  |</a> 
<a name="line589">589  |</a> /*#+func-----------------------------------------------------------------------
<a name="line590">590  |</a>     FUNCTION: first_link_on_screen()
<a name="line591">591  |</a>      PURPOSE: Find first link which fits on the screen
<a name="line592">592  |</a>       SYNTAX: int first_link_on_screen(int sl, int el, int n);
<a name="line593">593  |</a>               int sl: first textbuffer line in window.
<a name="line594">594  |</a>               int el: last textbuffer line in window
<a name="line595">595  |</a>               int ll: line of textbuffer with first link in it
<a name="line596">596  |</a>               int n : number of topics
<a name="line597">597  |</a>  DESCRIPTION:
<a name="line598">598  |</a>      RETURNS: The index of the first link which fits on the screen,
<a name="line599">599  |</a>               -1 if no link on the screen visible.
<a name="line600">600  |</a>      HISTORY: 07-Oct-1992 20:42:24 V0.1
<a name="line601">601  |</a> --#-func----------------------------------------------------------------------*/
<a name="line602">602  |</a> int first_link_on_screen(int sl, int el, int *ll, int n)
<a name="line603">603  |</a> {
<a name="line604">604  |</a>   int i;
<a name="line605">605  |</a> 
<a name="line606">606  |</a>   i = 0;
<a name="line607">607  |</a>   *ll = topic_link[i].line;
<a name="line608">608  |</a> 
<a name="line609">609  |</a>   while (i &lt; n &amp;&amp; *ll &lt; sl) {
<a name="line610">610  |</a>     *ll = topic_link[i].line;
<a name="line611">611  |</a>     if (*ll &gt;= sl &amp;&amp; *ll &lt;= el)
<a name="line612">612  |</a>       return(i);
<a name="line613">613  |</a>     if (*ll &gt;= el)
<a name="line614">614  |</a>       return(-1);
<a name="line615">615  |</a>     i++;
<a name="line616">616  |</a>   }
<a name="line617">617  |</a>   return(i-1);
<a name="line618">618  |</a> }
<a name="line619">619  |</a> 
<a name="line620">620  |</a> /*#+func-----------------------------------------------------------------------
<a name="line621">621  |</a>     FUNCTION: last_link_on_screen()
<a name="line622">622  |</a>      PURPOSE: Find last link which fits on the screen
<a name="line623">623  |</a>       SYNTAX: int last_link_on_screen(int sl, int el, int n);
<a name="line624">624  |</a>               int sl: number of first textline on the screen
<a name="line625">625  |</a>               int el: number of last textline on the screen,
<a name="line626">626  |</a>               int *ll: linenumber of textbuffer with link found
<a name="line627">627  |</a>               int n : number of topics
<a name="line628">628  |</a>  DESCRIPTION: -
<a name="line629">629  |</a>      RETURNS: The index of the last link which fits on the screen,
<a name="line630">630  |</a>               -1 if no link on the screen visible.
<a name="line631">631  |</a>      HISTORY: 07-Oct-1992 20:42:24 V0.1
<a name="line632">632  |</a> --#-func----------------------------------------------------------------------*/
<a name="line633">633  |</a> int last_link_on_screen(int sl, int el, int *ll, int n)
<a name="line634">634  |</a> {
<a name="line635">635  |</a>   int i;
<a name="line636">636  |</a> 
<a name="line637">637  |</a>   i = n-1;
<a name="line638">638  |</a>   *ll = topic_link[i].line;
<a name="line639">639  |</a> 
<a name="line640">640  |</a>   while (i &gt;= 0 &amp;&amp; *ll &gt;= 0) {
<a name="line641">641  |</a>     *ll = topic_link[i].line;
<a name="line642">642  |</a>     if (*ll &lt;= el &amp;&amp; *ll &gt;= sl)         /* Break if within screen      */
<a name="line643">643  |</a>       return(i);
<a name="line644">644  |</a>     if (*ll &lt; sl)                       /* Break if past top of screen */
<a name="line645">645  |</a>       return(-1);
<a name="line646">646  |</a>     i--;
<a name="line647">647  |</a>   }
<a name="line648">648  |</a>   return(-1);
<a name="line649">649  |</a> 
<a name="line650">650  |</a> }
<a name="line651">651  |</a> /*#+func-------------------------------------------------------------------
<a name="line652">652  |</a>    FUNCTION: show_topic(long offset)
<a name="line653">653  |</a>     PURPOSE: Show text of current topic
<a name="line654">654  |</a>  DESRIPTION: The text of the topic will be read and displayed. As a start,
<a name="line655">655  |</a>              only the first page will be read in and displayed, then the
<a name="line656">656  |</a>              rest of the text. The links will have a special color, and th
<a name="line657">657  |</a>              active link will be highlighted.
<a name="line658">658  |</a>              The following keys will be handeled:
<a name="line659">659  |</a>                ARROW_UP,
<a name="line660">660  |</a>                ARROW_DOWN,
<a name="line661">661  |</a>                PAGE_UP,
<a name="line662">662  |</a>                PAGE_DOWN,
<a name="line663">663  |</a>                ARRROW_LEFT,
<a name="line664">664  |</a>                ARROW_RIGHT,
<a name="line665">665  |</a>                ENTER,
<a name="line666">666  |</a>                ESC.
<a name="line667">667  |</a> 
<a name="line668">668  |</a>              Reaction on keys:
<a name="line669">669  |</a> 
<a name="line670">670  |</a>              ARROW_RIGHT: go to next link on the page. If the link is not
<a name="line671">671  |</a>                on the page, then rearrange the page, so the next link is
<a name="line672">672  |</a>                on the top line of the page.
<a name="line673">673  |</a> 
<a name="line674">674  |</a>              ARROW_LEFT: go to previous link on the page. If the link is not
<a name="line675">675  |</a>                on the page, then rearrange the page, so the link is on the
<a name="line676">676  |</a>                startline of the page.
<a name="line677">677  |</a> 
<a name="line678">678  |</a>              PAGE_UP: Go one screen of text back. The selected link will be
<a name="line679">679  |</a>                the last link on the screen.
<a name="line680">680  |</a> 
<a name="line681">681  |</a>              PAGE_DOWN: Go one screen of text ahead. The selected link will
<a name="line682">682  |</a>                be the first link on the screen.
<a name="line683">683  |</a> 
<a name="line684">684  |</a>              ARROW_UP: Scroll the page one line down (back in text). If the
<a name="line685">685  |</a>                selected link disappears from the screen, the new selected link
<a name="line686">686  |</a>                will be the last link on the screen.
<a name="line687">687  |</a> 
<a name="line688">688  |</a>              ARROW_DOWN: Scroll the page one line up (forward in text). If the
<a name="line689">689  |</a>                selected link 'disappears' from the screen, the new selected
<a name="line690">690  |</a>                link will be the first link on the screen.
<a name="line691">691  |</a> 
<a name="line692">692  |</a>              ENTER: Go to selected link and display its text
<a name="line693">693  |</a> 
<a name="line694">694  |</a>              ESC: return to previous link or exit help if no previous link
<a name="line695">695  |</a>                exists.
<a name="line696">696  |</a> 
<a name="line697">697  |</a>     RETURNS: Nothing
<a name="line698">698  |</a>     VERSION: 901114 V0.1
<a name="line699">699  |</a> --#-func-------------------------------------------------------------------*/
<a name="line700">700  |</a> static void show_topic(long offset)
<a name="line701">701  |</a> {
<a name="line702">702  |</a>   /*------------
<a name="line703">703  |</a>     Variables
<a name="line704">704  |</a>   ------------*/
<a name="line705">705  |</a>   int no_lines;                 /* No of lines of topic        */
<a name="line706">706  |</a>   unsigned int choise;                   /* User input                  */
<a name="line707">707  |</a>   int flag = 0;                 /* Flag for reading topic text */
<a name="line708">708  |</a>   int old_link = 0;
<a name="line709">709  |</a>   int old_linkline;
<a name="line710">710  |</a>   int linkline;
<a name="line711">711  |</a> 
<a name="line712">712  |</a>   /*-------------------
<a name="line713">713  |</a>     Initializations
<a name="line714">714  |</a>   -------------------*/
<a name="line715">715  |</a>   startline = 0;
<a name="line716">716  |</a> 
<a name="line717">717  |</a>   link_selected = 0;
<a name="line718">718  |</a>   old_linkline  = startline;
<a name="line719">719  |</a> 
<a name="line720">720  |</a> 
<a name="line721">721  |</a>   /*------------------------------------
<a name="line722">722  |</a>     Get first screen of text from topic
<a name="line723">723  |</a>   ------------------------------------*/
<a name="line724">724  |</a>   no_lines = filbuf(offset, flag++);
<a name="line725">725  |</a> 
<a name="line726">726  |</a>   /*-------------------
<a name="line727">727  |</a>     Show first screen
<a name="line728">728  |</a>   --------------------*/
<a name="line729">729  |</a>   wn_clear(wn);
<a name="line730">730  |</a>   redraw_helpscreen(wn,startline,no_lines);
<a name="line731">731  |</a> 
<a name="line732">732  |</a>   /*----------------
<a name="line733">733  |</a>     Show the text
<a name="line734">734  |</a>   ----------------*/
<a name="line735">735  |</a>   while(TRUE)
<a name="line736">736  |</a>   {
<a name="line737">737  |</a>     endline      = startline+height-1;
<a name="line738">738  |</a>     linkline     = topic_link[link_selected].line;
<a name="line739">739  |</a>     old_linkline = topic_link[old_link].line;
<a name="line740">740  |</a> 
<a name="line741">741  |</a>     /*----------------------------------------
<a name="line742">742  |</a>       Hide old selected link and show new one
<a name="line743">743  |</a>     -----------------------------------------*/
<a name="line744">744  |</a>     /* link is on the same line */
<a name="line745">745  |</a>     if ((link_selected != old_link) &amp;&amp; old_linkline == linkline)
<a name="line746">746  |</a>       show_line(wn,linkline,topic_txt[linkline]);
<a name="line747">747  |</a>     else {
<a name="line748">748  |</a>       if (old_linkline &gt;= startline &amp;&amp; old_linkline &lt;= endline)
<a name="line749">749  |</a>         show_line(wn,old_linkline,topic_txt[old_linkline]);
<a name="line750">750  |</a>       if (linkline &gt;= startline &amp;&amp; linkline &lt;= endline)
<a name="line751">751  |</a>         show_line(wn,linkline,topic_txt[linkline]);
<a name="line752">752  |</a>     }
<a name="line753">753  |</a> 
<a name="line754">754  |</a>     /*------------------------------------
<a name="line755">755  |</a>       Read complete text for this topic
<a name="line756">756  |</a>       (only once, controlled by 'flag'
<a name="line757">757  |</a>     ------------------------------------*/
<a name="line758">758  |</a>     no_lines = filbuf(offset, flag++);
<a name="line759">759  |</a> 
<a name="line760">760  |</a>     /*----------------------------------------
<a name="line761">761  |</a>       Wait for valid keypress and react on it
<a name="line762">762  |</a>     -----------------------------------------*/
<a name="line763">763  |</a>     choise = waitkey();
<a name="line764">764  |</a>     wn_log(&quot;startline = %d   endline = %d   linkline = %d &quot;,startline,endline,linkline);
<a name="line765">765  |</a>     wn_log(&quot;height = %d no_lines = %d &quot;,height,no_lines);
<a name="line766">766  |</a>     wn_log(&quot;key pressed: %x\n&quot;,choise);
<a name="line767">767  |</a>     switch (choise)
<a name="line768">768  |</a>     {
<a name="line769">769  |</a>       case PAGE_UP:
<a name="line770">770  |</a>         /*---------------------------------------
<a name="line771">771  |</a>           Scroll the screen 1 page up
<a name="line772">772  |</a>         ---------------------------------------*/
<a name="line773">773  |</a>         startline -= height;
<a name="line774">774  |</a>         endline   -= height;
<a name="line775">775  |</a>         check_screen(&amp;startline,&amp;endline,no_lines);
<a name="line776">776  |</a>         redraw_helpscreen(wn,startline,no_lines);
<a name="line777">777  |</a>         if (linkline &gt; endline) {
<a name="line778">778  |</a>           link_selected = last_link_on_screen(startline,endline,&amp;linkline,no_topics);
<a name="line779">779  |</a>           if (linkline &gt;= 0)
<a name="line780">780  |</a>             show_line(wn,linkline,topic_txt[linkline]);
<a name="line781">781  |</a>         }
<a name="line782">782  |</a>         break;
<a name="line783">783  |</a> 
<a name="line784">784  |</a>       case PAGE_DOWN:
<a name="line785">785  |</a>         /*---------------------------------------
<a name="line786">786  |</a>           Scroll the screen 1 page down
<a name="line787">787  |</a>         ---------------------------------------*/
<a name="line788">788  |</a>         startline += height;
<a name="line789">789  |</a>         endline   += height;
<a name="line790">790  |</a>         check_screen(&amp;startline,&amp;endline,no_lines);
<a name="line791">791  |</a>         redraw_helpscreen(wn,startline,no_lines);
<a name="line792">792  |</a>         if (linkline &lt; startline) {
<a name="line793">793  |</a>           link_selected = first_link_on_screen(startline,endline,&amp;linkline,no_topics);
<a name="line794">794  |</a>           if (linkline &gt;= 0)
<a name="line795">795  |</a>             show_line(wn,linkline,topic_txt[linkline]);
<a name="line796">796  |</a>         }
<a name="line797">797  |</a>         break;
<a name="line798">798  |</a> 
<a name="line799">799  |</a>       case ARROW_UP:
<a name="line800">800  |</a>         /*---------------------------------------
<a name="line801">801  |</a>           Scroll the screen 1 line down
<a name="line802">802  |</a>         ---------------------------------------*/
<a name="line803">803  |</a>         if (startline &gt; 0) {
<a name="line804">804  |</a>           startline--;
<a name="line805">805  |</a>           endline--;
<a name="line806">806  |</a>           wn_scroll(wn,-1);
<a name="line807">807  |</a>           show_line(wn,startline,topic_txt[startline]);
<a name="line808">808  |</a>         }
<a name="line809">809  |</a>         /*---------------------------------------
<a name="line810">810  |</a>           Check if selected link is not
<a name="line811">811  |</a>           outside the screen. If so, search
<a name="line812">812  |</a>           for new link and show this line
<a name="line813">813  |</a>         ---------------------------------------*/
<a name="line814">814  |</a>         if (linkline &gt;= endline) {
<a name="line815">815  |</a>           old_link = link_selected;       /* Save old link */
<a name="line816">816  |</a>           while (linkline &gt;= endline &amp;&amp; link_selected &gt; 0) {
<a name="line817">817  |</a>             link_selected = prev_link(link_selected,no_topics);
<a name="line818">818  |</a>           }
<a name="line819">819  |</a>           show_line(wn,linkline,topic_txt[linkline]);
<a name="line820">820  |</a>         }
<a name="line821">821  |</a>         break;
<a name="line822">822  |</a> 
<a name="line823">823  |</a>       case ARROW_DOWN:
<a name="line824">824  |</a>         /*---------------------------------------
<a name="line825">825  |</a>           Scroll the screen 1 line up
<a name="line826">826  |</a>         ---------------------------------------*/
<a name="line827">827  |</a>         if (endline &lt; no_lines) {
<a name="line828">828  |</a>           startline++;
<a name="line829">829  |</a>           endline++;
<a name="line830">830  |</a>           wn_scroll(wn,1);
<a name="line831">831  |</a>           show_line(wn,endline,topic_txt[endline]);
<a name="line832">832  |</a>         }
<a name="line833">833  |</a>         if (linkline &lt; startline) {
<a name="line834">834  |</a>           link_selected = first_link_on_screen(startline,endline,&amp;linkline,no_topics);
<a name="line835">835  |</a>           if (linkline &gt;= 0)
<a name="line836">836  |</a>             show_line(wn,linkline,topic_txt[linkline]);
<a name="line837">837  |</a>         }
<a name="line838">838  |</a>         break;
<a name="line839">839  |</a> 
<a name="line840">840  |</a>       case ARROW_LEFT:
<a name="line841">841  |</a>         /*---------------------------------------
<a name="line842">842  |</a>           Goto previous link
<a name="line843">843  |</a>         ---------------------------------------*/
<a name="line844">844  |</a>         old_link = link_selected;
<a name="line845">845  |</a>         link_selected = prev_link(link_selected,no_topics);
<a name="line846">846  |</a>         linkline = topic_link[link_selected].line;
<a name="line847">847  |</a>         if (linkline &lt; startline) {
<a name="line848">848  |</a>           startline = linkline;
<a name="line849">849  |</a>           redraw_helpscreen(wn,startline,no_lines);
<a name="line850">850  |</a>         }
<a name="line851">851  |</a>         break;
<a name="line852">852  |</a> 
<a name="line853">853  |</a>       case HT:
<a name="line854">854  |</a>       case ARROW_RIGHT:
<a name="line855">855  |</a>         /*---------------------------------------
<a name="line856">856  |</a>           Goto next link
<a name="line857">857  |</a>         ---------------------------------------*/
<a name="line858">858  |</a>         old_link = link_selected;
<a name="line859">859  |</a>         link_selected = next_link(link_selected,no_topics);
<a name="line860">860  |</a>         linkline = topic_link[link_selected].line;
<a name="line861">861  |</a>         if (linkline &gt; endline) {
<a name="line862">862  |</a>           endline = linkline;
<a name="line863">863  |</a>           startline = endline - height + 1;
<a name="line864">864  |</a>           redraw_helpscreen(wn,startline,no_lines);
<a name="line865">865  |</a>         }
<a name="line866">866  |</a>         break;
<a name="line867">867  |</a> 
<a name="line868">868  |</a>       /*----------------------------------
<a name="line869">869  |</a>         Get topic key if ENTER is pressed
<a name="line870">870  |</a>       -----------------------------------*/
<a name="line871">871  |</a>       case ENTER:
<a name="line872">872  |</a>         if (no_topics &gt; 0)
<a name="line873">873  |</a>         {
<a name="line874">874  |</a>           push_subject(subject);
<a name="line875">875  |</a>           strcpy(current_subject,topic_link[link_selected].key);
<a name="line876">876  |</a>           subject = current_subject;
<a name="line877">877  |</a>         }
<a name="line878">878  |</a>         return;
<a name="line879">879  |</a>         break;
<a name="line880">880  |</a> 
<a name="line881">881  |</a>       /*---------------
<a name="line882">882  |</a>         Quit from help
<a name="line883">883  |</a>       -----------------*/
<a name="line884">884  |</a>       case ESC_KEY:
<a name="line885">885  |</a>         subject = pop_subject();
<a name="line886">886  |</a>         if (subject)
<a name="line887">887  |</a>         {
<a name="line888">888  |</a>           strcpy(current_subject,subject);
<a name="line889">889  |</a>           subject = current_subject;
<a name="line890">890  |</a>         }
<a name="line891">891  |</a>         return;
<a name="line892">892  |</a>         break;
<a name="line893">893  |</a>     }
<a name="line894">894  |</a>   }
<a name="line895">895  |</a> }
<a name="line896">896  |</a> 
<a name="line897">897  |</a> 
<a name="line898">898  |</a> /*#+func-------------------------------------------------------------------
<a name="line899">899  |</a>    FUNCTION: filbuf()
<a name="line900">900  |</a>     PURPOSE: Fill text buffer with text from helpfile
<a name="line901">901  |</a>  DESRIPTION: If flag = 0 then read only first screen of topic
<a name="line902">902  |</a>              If flag = 1 then read complete topic
<a name="line903">903  |</a>              If flag &gt; 1 then return immediately
<a name="line904">904  |</a>     RETURNS: Number of lines on the page
<a name="line905">905  |</a>     HISTORY: 901114 V0.1
<a name="line906">906  |</a>              920205 V0.2 - Added flag to speed up reading
<a name="line907">907  |</a>              28-Sep-1992 21:09:48 V0.3 - Changed algoritme to get tokens
<a name="line908">908  |</a> --#-func-------------------------------------------------------------------*/
<a name="line909">909  |</a> static int filbuf(long offset, int flag)
<a name="line910">910  |</a> {
<a name="line911">911  |</a>   int    i,j;
<a name="line912">912  |</a>   static int no_lines;
<a name="line913">913  |</a>   char   line[HELP_LINE_LEN];  /* line buffer       */
<a name="line914">914  |</a>   char   token[80];            /* Pointer to token  */
<a name="line915">915  |</a>   int    pos,len;
<a name="line916">916  |</a> 
<a name="line917">917  |</a>   /*-------------------------------
<a name="line918">918  |</a>     If flag == 1 Return immediately.
<a name="line919">919  |</a>     The complete text of the topic
<a name="line920">920  |</a>     has been read already
<a name="line921">921  |</a>   ---------------------------------*/
<a name="line922">922  |</a>   if (flag &gt; 1)
<a name="line923">923  |</a>     return(no_lines);
<a name="line924">924  |</a> 
<a name="line925">925  |</a>   /*----------------------
<a name="line926">926  |</a>     Initialize variables
<a name="line927">927  |</a>   -----------------------*/
<a name="line928">928  |</a>   no_lines=0;
<a name="line929">929  |</a>   no_topics = 0;          /* Number of links in the list */
<a name="line930">930  |</a> 
<a name="line931">931  |</a>   /*-----------------------------------
<a name="line932">932  |</a>     Position file pointer on topic key
<a name="line933">933  |</a>   -----------------------------------*/
<a name="line934">934  |</a>   fseek(fp, offset, 0);       /* position file               */
<a name="line935">935  |</a> 
<a name="line936">936  |</a>   /*---------------------------------
<a name="line937">937  |</a>     Read and process the topic text
<a name="line938">938  |</a>   ----------------------------------*/
<a name="line939">939  |</a>   do
<a name="line940">940  |</a>   {
<a name="line941">941  |</a>     fgets(line, 132, fp);     /* fetch a line              */
<a name="line942">942  |</a> 
<a name="line943">943  |</a>     /*-----------------------
<a name="line944">944  |</a>       Check for end of file
<a name="line945">945  |</a>     ------------------------*/
<a name="line946">946  |</a>     if (!strcmp(&quot;*END*\n&quot;,line))
<a name="line947">947  |</a>       break;
<a name="line948">948  |</a> 
<a name="line949">949  |</a>     /*---------------------------------
<a name="line950">950  |</a>       Check for start of next topic
<a name="line951">951  |</a>     -----------------------------------*/
<a name="line952">952  |</a>     if (line[0] == ':')
<a name="line953">953  |</a>        break;
<a name="line954">954  |</a> 
<a name="line955">955  |</a>     /*----------------------
<a name="line956">956  |</a>       Check for file title
<a name="line957">957  |</a>     -----------------------*/
<a name="line958">958  |</a>     if (line[0] == '@')
<a name="line959">959  |</a>       break;
<a name="line960">960  |</a> 
<a name="line961">961  |</a>     /*----------------------
<a name="line962">962  |</a>       Strip LF from string
<a name="line963">963  |</a>     -----------------------*/
<a name="line964">964  |</a>     len = strlen(line);
<a name="line965">965  |</a>     line[len-1] = '\0';
<a name="line966">966  |</a> 
<a name="line967">967  |</a>     strcpy(topic_txt[no_lines],line);
<a name="line968">968  |</a> 
<a name="line969">969  |</a>     /*----------------------------------------------------
<a name="line970">970  |</a>       Check the line for subtopic links.
<a name="line971">971  |</a>       If one is found, add this to the subtopic link list
<a name="line972">972  |</a>     -----------------------------------------------------*/
<a name="line973">973  |</a>     i = 0;
<a name="line974">974  |</a>     while (strchr(&amp;line[i],'~')) {
<a name="line975">975  |</a>       /*---------------------------------------
<a name="line976">976  |</a>         Extract token from the line
<a name="line977">977  |</a>       ---------------------------------------*/
<a name="line978">978  |</a>       while (line[i] &amp;&amp; line[i] != '~') i++;     /* Find first '~' */
<a name="line979">979  |</a>       pos = i;                                   /* Save position  */
<a name="line980">980  |</a> 
<a name="line981">981  |</a>       j = 0;
<a name="line982">982  |</a>       i++;                                       /* Point after first '~' */
<a name="line983">983  |</a>       while (line[i] &amp;&amp; line[i] != '~') token[j++] = line[i++]; /* Extr. token */
<a name="line984">984  |</a>       token[j] = '\0';                           /* End of string         */
<a name="line985">985  |</a>       i++;                                       /* Point after 2nd '~'   */
<a name="line986">986  |</a> 
<a name="line987">987  |</a>       /*---------------------------------------
<a name="line988">988  |</a>         Set the topic variables
<a name="line989">989  |</a>       ---------------------------------------*/
<a name="line990">990  |</a>       strcpy(topic_link[no_topics].key,token);
<a name="line991">991  |</a>       topic_link[no_topics].line = no_lines;
<a name="line992">992  |</a>       topic_link[no_topics].pos  = pos;
<a name="line993">993  |</a>       len = strlen(token);
<a name="line994">994  |</a>       topic_link[no_topics].len  = len;
<a name="line995">995  |</a>       topic_txt[no_lines][pos]       = ' ';   /* 0x10; */       /* Mark begin of link */
<a name="line996">996  |</a>       topic_txt[no_lines][pos+len+1] = ' ';   /* 0x11; */      /* Mark end of link   */
<a name="line997">997  |</a>       no_topics++;
<a name="line998">998  |</a>     }
<a name="line999">999  |</a> 
<a name="line1000">1000 |</a>     no_lines++;
<a name="line1001">1001 |</a> 
<a name="line1002">1002 |</a>     /*----------------------------------------------
<a name="line1003">1003 |</a>       If flag is zero, then check if first screen
<a name="line1004">1004 |</a>       is completely read.
<a name="line1005">1005 |</a>     ------------------------------------------------*/
<a name="line1006">1006 |</a>     if (flag == 0 &amp;&amp; no_lines &gt;= height)
<a name="line1007">1007 |</a>       break;
<a name="line1008">1008 |</a> 
<a name="line1009">1009 |</a>   }
<a name="line1010">1010 |</a>   while (TRUE);
<a name="line1011">1011 |</a> 
<a name="line1012">1012 |</a>   /*------------------------------------
<a name="line1013">1013 |</a>     Clear remainder of topic text lines
<a name="line1014">1014 |</a>   -------------------------------------*/
<a name="line1015">1015 |</a>   for (j=no_lines ; j &lt; MAX_LINES ; j++)
<a name="line1016">1016 |</a>     topic_txt[j][0] = '\0';
<a name="line1017">1017 |</a> 
<a name="line1018">1018 |</a>   /*------------------------------------
<a name="line1019">1019 |</a>     Clear remainder of topic link list
<a name="line1020">1020 |</a>   -------------------------------------*/
<a name="line1021">1021 |</a>   for (j=no_topics ; j&lt; MAXKEY ; j++)
<a name="line1022">1022 |</a>   {
<a name="line1023">1023 |</a>     topic_link[j].key[0] = '\0';
<a name="line1024">1024 |</a>     topic_link[j].line   = -1;
<a name="line1025">1025 |</a>     topic_link[j].pos    = -1;
<a name="line1026">1026 |</a>     topic_link[j].len    = -1;
<a name="line1027">1027 |</a>   }
<a name="line1028">1028 |</a> 
<a name="line1029">1029 |</a>   return(no_lines);
<a name="line1030">1030 |</a> }
<a name="line1031">1031 |</a> 
<a name="line1032">1032 |</a> /*#+func-----------------------------------------------------------------------
<a name="line1033">1033 |</a>     FUNCTION: show_line()
<a name="line1034">1034 |</a>      PURPOSE: Show a line on a help page
<a name="line1035">1035 |</a>       SYNTAX: static void show_line(WINDOW *w, int linenr, char *s);
<a name="line1036">1036 |</a>  DESCRIPTION: WINDOW *w : pointer to opened help window
<a name="line1037">1037 |</a>               int linenr: linenumber of textbuffer to print in window
<a name="line1038">1038 |</a>               char *s   : text to show
<a name="line1039">1039 |</a>       GLOBAL: int startline = first line of textbuffer in the window
<a name="line1040">1040 |</a>      RETURNS: Nothing
<a name="line1041">1041 |</a>      HISTORY: 14-Oct-1993 V0.2 - Now uses a window instead of direct screen...
<a name="line1042">1042 |</a> --#-func----------------------------------------------------------------------*/
<a name="line1043">1043 |</a> static void show_line(WINDOW *w, int linenr, char *s)
<a name="line1044">1044 |</a> {
<a name="line1045">1045 |</a>   int  link;
<a name="line1046">1046 |</a>   int  i;
<a name="line1047">1047 |</a>   int  w_line;        /* Window line number */
<a name="line1048">1048 |</a> 
<a name="line1049">1049 |</a>   /*-------------------
<a name="line1050">1050 |</a>     Initializations
<a name="line1051">1051 |</a>   -------------------*/
<a name="line1052">1052 |</a>   w_line = linenr - startline;
<a name="line1053">1053 |</a> 
<a name="line1054">1054 |</a>   /*-------------------------------
<a name="line1055">1055 |</a>     Clear the line in the window
<a name="line1056">1056 |</a>   -------------------------------*/
<a name="line1057">1057 |</a>   wn_fill(w,w_line,0,w-&gt;xsize-2,1,' ',_help_text);
<a name="line1058">1058 |</a> 
<a name="line1059">1059 |</a>   switch(s[0]) {
<a name="line1060">1060 |</a>     case '^':       /* Centered, highlighted line */
<a name="line1061">1061 |</a>       wn_locate(w,w_line,5);  /* Not centered yet */
<a name="line1062">1062 |</a>       wn_printf(w,&quot;%s&quot;,s+1);
<a name="line1063">1063 |</a>       return;
<a name="line1064">1064 |</a>       break;
<a name="line1065">1065 |</a>     case '%':       /* Complete highlighted line */
<a name="line1066">1066 |</a>       wn_setattrib(w,w_line,0,w-&gt;xsize-2,1,_help_bold);
<a name="line1067">1067 |</a>       wn_locate(w,w_line,0);
<a name="line1068">1068 |</a>       wn_printf(w,&quot;%s&quot;,s+1);
<a name="line1069">1069 |</a>       return;
<a name="line1070">1070 |</a>       break;
<a name="line1071">1071 |</a>     default:
<a name="line1072">1072 |</a>       if (*s) {
<a name="line1073">1073 |</a>         wn_locate(w,w_line,0);
<a name="line1074">1074 |</a>         wn_printf(w,&quot;%s&quot;,s+1);
<a name="line1075">1075 |</a>       }
<a name="line1076">1076 |</a>       break;
<a name="line1077">1077 |</a>   }
<a name="line1078">1078 |</a> 
<a name="line1079">1079 |</a>   /*------------------------------------------
<a name="line1080">1080 |</a>     Check if this line has a topic link in it
<a name="line1081">1081 |</a>   --------------------------------------------*/
<a name="line1082">1082 |</a>   i = 0;
<a name="line1083">1083 |</a>   link = find_topiclink(linenr,i);
<a name="line1084">1084 |</a>   while (link &gt;= 0) {
<a name="line1085">1085 |</a>     /*----------------------------------
<a name="line1086">1086 |</a>       Set the attributes of a link key
<a name="line1087">1087 |</a>     -----------------------------------*/
<a name="line1088">1088 |</a>     if (link == link_selected)
<a name="line1089">1089 |</a>       wn_setattrib(w,w_line,topic_link[link].pos,topic_link[link].len,1,
<a name="line1090">1090 |</a>                 _help_linkselect);
<a name="line1091">1091 |</a>     /*------------------------------
<a name="line1092">1092 |</a>       Highlight the selected link
<a name="line1093">1093 |</a>     ------------------------------*/
<a name="line1094">1094 |</a>     else
<a name="line1095">1095 |</a>       wn_setattrib(w,w_line,topic_link[link].pos,topic_link[link].len,1,
<a name="line1096">1096 |</a>                 _help_topiclink);
<a name="line1097">1097 |</a> 
<a name="line1098">1098 |</a>     /*---------------------------------
<a name="line1099">1099 |</a>       Find the next topic on this line
<a name="line1100">1100 |</a>     ----------------------------------*/
<a name="line1101">1101 |</a>     i++;
<a name="line1102">1102 |</a>     link = find_topiclink(linenr,i);
<a name="line1103">1103 |</a>   }
<a name="line1104">1104 |</a> }
<a name="line1105">1105 |</a> 
<a name="line1106">1106 |</a> /*#+func-----------------------------------------------------------------------
<a name="line1107">1107 |</a>     FUNCTION: exit_help()
<a name="line1108">1108 |</a>      PURPOSE: exit from windowed help function
<a name="line1109">1109 |</a>  DESCRIPTION: free allocated memory for topic key buffer
<a name="line1110">1110 |</a>      RETURNS: nothing
<a name="line1111">1111 |</a>      HISTORY: 920107 V0.1 - Initial version
<a name="line1112">1112 |</a> --#-func----------------------------------------------------------------------*/
<a name="line1113">1113 |</a> void exit_help()
<a name="line1114">1114 |</a> {
<a name="line1115">1115 |</a>   free(topic_key_buffer);
<a name="line1116">1116 |</a> }
</pre>

</BODY>
</HTML>
